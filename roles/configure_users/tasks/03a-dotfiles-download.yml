---
- name: Get the user's home directory
  ansible.builtin.set_fact:
    user_home: "{{ getent_passwd[loop_user][4] }}"

- name: Create folder structure
  become: true
  become_user: "{{ loop_user }}"
  ansible.builtin.file:
    path: "{{ (user_home + '/' + item['dest']) | dirname }}"
    state: directory
    mode: "0700"
  loop: "{{ configure_users_dotfiles }}"

- name: Copy dotfiles per vars
  become: true
  become_user: "{{ loop_user }}"
  ansible.builtin.get_url:
    url: "{{ item['url'] }}"
    dest: "{{ user_home }}/{{ item['dest'] }}"
    owner: "{{ loop_user }}"
    group: "{{ loop_user }}"
    mode: "0660"
  loop: "{{ configure_users_dotfiles }}"
