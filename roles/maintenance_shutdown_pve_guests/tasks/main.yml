---
- name: Get Proxmox Guests
  delegate_to: localhost
  become: false
  run_once: true
  community.proxmox.proxmox_vm_info:
    api_user: root@pam
    api_password: "{{ secret_proxmox_password }}"
    api_host: "{{ proxmox_api_host }}"
  register: maintenance_shutdown_pve_guests_guests
  retries: 5
  delay: 10

- name: Shutdown Proxmox Guests
  delegate_to: localhost
  become: false
  run_once: true
  community.proxmox.proxmox:
    api_user: root@pam
    api_password: "{{ secret_proxmox_password }}"
    api_host: "{{ proxmox_api_host }}"
    vmid: "{{ item.vmid }}"
    state: stopped
    force: false
  loop: "{{ maintenance_shutdown_pve_guests_guests.proxmox_vms }}"
  failed_when: false # We ball
