---
- name: Install NFS server apt
  ansible.builtin.apt:
    name: nfs-common
    state: present
  when: ansible_pkg_mgr == 'apt'

- name: Install NFS server dnf
  ansible.builtin.dnf:
    name: nfs-utils
    state: present
  when: ansible_pkg_mgr == 'dnf'

- name: Create directories
  ansible.builtin.file:
    path: /mnt/{{ item.key }}
    state: directory
    owner: root
    group: root
    mode: "0655"
  with_dict: "{{ nfs_client_mounts }}"

- name: Copy systemd mount files
  ansible.builtin.copy:
    dest: /etc/systemd/system/mnt-{{ item.key }}.mount
    content: |-
      [Unit]
      Description=Mount {{ item.key }}
      After=rpcbind.target
      Requires=remote-fs-pre.target

      [Mount]
      What={{ item.value }}:/srv/{{ item.key }}
      Where=/mnt/{{ item.key }}
      Type=nfs
      TimeoutSec=5s
      Options=vers=3,tcp,timeo=60,soft

      [Install]
      WantedBy=multi-user.target
    mode: "0644"
  with_dict: "{{ nfs_client_mounts }}"
  notify: Reload systemd

- name: Start mount services
  ansible.builtin.systemd:
    name: "mnt-{{ item.key }}.mount"
    enabled: true
    state: started
  with_dict: "{{ nfs_client_mounts }}"
