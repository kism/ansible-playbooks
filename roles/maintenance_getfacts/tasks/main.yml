---
- name: Gather facts
  ansible.builtin.setup:

- name: Populate service facts
  ansible.builtin.service_facts:

- name: Get user info
  ansible.builtin.getent:
    database: passwd

- name: Get group info
  ansible.builtin.getent:
    database: group

- name: Set debug mode to value of print_debug if its defined
  ansible.builtin.set_fact:
    maintenance_getfacts_print_debug: "{{ print_debug }}"
  when: print_debug is defined

- name: Debug block chuck vars into a file
  delegate_to: localhost
  when: maintenance_getfacts_print_debug
  block:
    # Start outputting to a ansible_distribution_file_variety
    - name: Make temp var so we capture the ansible_facts key
      ansible.builtin.set_fact:
        debug_yaml_output: {}

    - name: Copy ansible_facts into debug_yaml_output var
      ansible.builtin.set_fact:
        debug_yaml_output: "{{ debug_yaml_output | combine({'ansible_facts': ansible_facts}) }}"

    - name: Put facts in a nice yaml
      ansible.builtin.copy:
        dest: "{{ maintenance_getfacts_debug_file }}"
        content: "{{ debug_yaml_output | to_yaml(default_flow_style=False) }}"
        mode: "0660"

    - name: Prepend to make valid yml file
      ansible.builtin.lineinfile:
        path: "{{ maintenance_getfacts_debug_file }}"
        insertbefore: BOF
        line: "---"

- name: Print the usual culperates
  ansible.builtin.debug:
    msg:
      - '# Host #'
      - "ansible_hostname:                   {{ ansible_hostname }}"
      - "ansible_distribution_file_variety:  {{ ansible_distribution_file_variety }}"
      - "ansible_distribution:               {{ ansible_distribution }}"
      - "ansible_distribution_major_version: {{ ansible_distribution_major_version }}"
      - "ansible_distribution_release:       {{ ansible_distribution_release }}"
      - "ansible_architecture:               {{ ansible_architecture }}"
      - "ansible_pkg_mgr:                    {{ ansible_pkg_mgr }}"
      - '# Runner #'
      - "env HOME:                           {{ lookup('ansible.builtin.env', 'HOME') }}"
      - "env USER:                           {{ lookup('ansible.builtin.env', 'USER') }}"
      - "env PWD:                            {{ lookup('ansible.builtin.env', 'PWD') }}"
      - "ansible_config_file:                {{ ansible_config_file }}"
      - "playbook_dir:                       {{ playbook_dir }}"
      - "role_path:                          {{ role_path }}"
      - "inventory_file:                     {{ inventory_file }}"
      - "ansible_search_path:                {{ ansible_search_path }}"
