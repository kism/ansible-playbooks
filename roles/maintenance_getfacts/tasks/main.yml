---
- name: Gather facts
  ansible.builtin.setup:

- name: Set debug mode to value of print_debug if its defined
  ansible.builtin.set_fact:
    maintenance_getfacts_print_debug: "{{ print_debug }}"
  when: print_debug is defined

- name: Debug block to print facts and vars
  when: maintenance_getfacts_print_debug
  block:
    - name: Get user info
      ansible.builtin.getent:
        database: passwd

    # ansible_facts.getent_passwd remains the same, these vars are weird
    # Name:Password:UserID:PrincipleGroup:Gecos:HomeDirectory:Shell
    - name: Transform user info
      ansible.builtin.set_fact:
        getent_passwd: "{{ getent_passwd | combine ({ item.key: item.value | join (':') }) }}"
      no_log: true
      loop: "{{ getent_passwd | dict2items }}"
      loop_control:
        label: "{{ item.key }}"

    - name: Get group info
      ansible.builtin.getent:
        database: group

    # ansible_facts.getent_group remains the same, these vars are weird
    # Name:Password:ID:User1,User2,...,Usern
    - name: Transform group info
      ansible.builtin.set_fact:
        getent_group: "{{ getent_group | combine ({ item.key: item.value | join (':') }) }}"
      no_log: true
      loop: "{{ getent_group | dict2items }}"
      loop_control:
        label: "{{ item.key }}"

    # Start printing

    - name: Print facts
      ansible.builtin.debug:
        msg: "{{ ansible_facts }}"

    - name: Print user facts
      ansible.builtin.debug:
        msg: "{{ getent_passwd }}"

    - name: Print group facts
      ansible.builtin.debug:
        msg: "{{ getent_group }}"

    - name: Print the usual culperates
      ansible.builtin.debug:
        msg:
          - "ansible_hostname:                   {{ ansible_hostname }}"
          - "ansible_distribution_file_variety:  {{ ansible_distribution_file_variety }}"
          - "ansible_distribution:               {{ ansible_distribution }}"
          - "ansible_distribution_major_version: {{ ansible_distribution_major_version }}"
          - "ansible_distribution_release:       {{ ansible_distribution_release }}"
          - "ansible_architecture:               {{ ansible_architecture }}"
          - "ansible_pkg_mgr:                    {{ ansible_pkg_mgr }}"
