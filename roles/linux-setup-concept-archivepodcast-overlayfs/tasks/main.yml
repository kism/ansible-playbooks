- name: Install DNF Packages
  ansible.builtin.dnf:
    pkg:
      - https://github.com/trapexit/mergerfs/releases/download/2.36.0/mergerfs-2.36.0-1.el9.aarch64.rpm
    disable_gpg_check: true
    state: present
  when: ansible_pkg_mgr == 'dnf' and ansible_architecture == 'aarch64'

- name: Install DNF Packages
  ansible.builtin.dnf:
    pkg:
      - https://github.com/trapexit/mergerfs/releases/download/2.36.0/mergerfs-2.36.0-1.el9.x86_64.rpm
    disable_gpg_check: true
    state: present
  when: ansible_pkg_mgr == 'dnf' and ansible_architecture == 'x86_64'

- name: Install APT Packages
  ansible.builtin.apt:
    pkg:
      - mergerfs
    state: present
  when: ansible_pkg_mgr == 'apt'

- name: Add the user 'podcasto' with a bash shell
  ansible.builtin.user:
    name: podcasto
    uid: 1083
    shell: /sbin/nologin

- name: Create directory for mergerfs
  file:
    path: /opt/archivepodcast/output
    state: directory
    owner: podcasto
    group: podcasto
    mode: 0700
    recurse: yes

- name: Create mergerfs mount for archivepodcast
  ansible.posix.mount:
    fstype: fuse.mergerfs
    src: /mnt/output1:/mnt/output2/
    path: /opt/archivepodcast/output
    opts: cache.files=off,dropcacheonclose=true,category.create=mfs
    state: mounted
