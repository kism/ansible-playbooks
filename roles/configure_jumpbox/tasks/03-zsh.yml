---
- name: Install zsh
  ansible.builtin.dnf:
    name:
      - zsh
    state: present

- name: Block to run as my user
  become: true
  become_user: kism
  block:
    - name: Create antigen folder
      ansible.builtin.file:
        path: "/home/kism/.antigen"
        state: directory
        owner: kism
        group: kism
        mode: "0770"

    - name: Download antigen
      ansible.builtin.get_url:
        url: https://git.io/antigen
        dest: "/home/kism/.antigen/antigen.zsh"
        owner: kism
        group: kism
        mode: "0770"

    - name: Copy bash config
      ansible.builtin.copy:
        src: files/jumpbox.zshrc
        dest: /home/kism/.zshrc
        owner: kism
        group: kism
        mode: "0644"

    - name: Setup zsh
      ansible.builtin.command:
        cmd: zsh -c ". /home/kism/.zshrc; antigen update; antigen reset"
      changed_when: false # Handled by the next task

    - name: Check if zsh has changed
      ansible.builtin.find:
        paths: "/home/kism/.antigen/bundles"
        age: 1m
        recurse: true
      register: modified_files
      changed_when: modified_files.files | length > 0

    - name: Change my shell to zsh
      ansible.builtin.user:
        name: kism
        shell: /bin/zsh
