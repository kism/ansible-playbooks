---
# no separate vars folder since this needs to be copypasted to archivepodcast and samba
- name: Variable for ffmpeg arch congigure_archivepodcast_arch_map
  ansible.builtin.set_fact:
    ffmpeg_arch_map: # uname (ansible), whatever ffmpeg uses
      x86_64: amd64
      aarch64: arm64
      armv6l: armel
      armv7l: armel
      armv8l: armel

- name: Get ffmpeg_arch
  block:
    - name: Set target arch per map if possible
      ansible.builtin.set_fact:
      ffmpeg_arch: "{{  ffmpeg_arch_map[ansible_architecture] }}"

  rescue:
    - name: Set default ffmpeg_arch
      ansible.builtin.set_fact:
      ffmpeg_arch: "{{ ansible_architecture }}"

- name: Create ffmpreg directory
  become: true
  become_user: root
  ansible.builtin.file:
    path: /opt/ffmpeg
    state: directory
    owner: root
    group: root
    mode: "0775"

- name: Change ownership on /opt/ffmpeg
  become: true
  become_user: root
  ansible.builtin.file:
    path: /opt/ffmpeg
    recurse: true
    owner: root
    group: root

- name: Grab ffmpeg aarch64
  ansible.builtin.unarchive:
    src: https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-{{ ffmpeg_arch }}-static.tar.xz
    dest: /opt/ffmpeg
    extra_opts: [--strip-components=1]
    remote_src: true
    owner: root
    group: root

- name: Create symbolic links to make sites available
  ansible.builtin.file:
    src: /opt/ffmpeg/{{ item }}
    dest: /usr/local/bin/{{ item }}
    owner: root
    group: root
    state: link
  loop:
    - ffmpeg
    - ffprobe
    - qt-faststart
