---
- name: Block with fun rescue
  block:
    - name: Update DNF Cache, list updates
      ansible.builtin.dnf:
        update_cache: true
        list: updates
      register: maintenance_update_packages_dnf_before

    - name: Wip update list to get changed
      ansible.builtin.debug: # WIP: nevra: 0:telegraf-1.30.2-1.aarch64
        msg: "{{ maintenance_update_packages_dnf_before }}"

    - name: Update dnf packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_only: true
      register: maintenance_update_packages_dnf_update
  rescue:
    - name: Run cleaning commands
      ansible.builtin.command:
        cmd: dnf clean all
      changed_when: true

    - name: Ensure removed cache
      ansible.builtin.file:
        path: /var/cache/dnf
        state: absent

    - name: Clear dnf cache
      ansible.builtin.command:
        cmd: dnf makecache --assumeyes
      changed_when: true # Technically untrue

    - name: Update dnf packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_only: true
      register: maintenance_update_packages_dnf_update

- name: Get only installed # WIP telegraf-1.30.2-1.aarch64
  ansible.builtin.set_fact:
    maintenance_update_packages_changed:
      host: "{{ ansible_hostname }}"
      packages: "{{ maintenance_update_packages_dnf_update.results | select('match', '^Installed: ') | map('regex_replace', '^Installed: ', '') | list }}"

- name: Set fact for maintenance_update_packages_changed
  ansible.builtin.set_fact:
    maintenance_update_packages_changed: "{{ [maintenance_update_packages_changed] | to_yaml(default_flow_style=False) }}"
