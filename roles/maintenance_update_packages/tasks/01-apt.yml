---
- name: Update APT database
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Get list of upgradable packages
  ansible.builtin.command:
    cmd: apt list --upgradable
  register: maintenance_update_packages_apt_before
  changed_when: false # Only getting info

- name: Update apt packages
  ansible.builtin.apt:
    upgrade: dist
    autoclean: true
    autoremove: true

- name: Get list of upgradable packages
  ansible.builtin.command:
    cmd: apt list --upgradable
  register: maintenance_update_packages_apt_after
  changed_when: false # Only getting info

- name: Set facts to do a diff
  ansible.builtin.set_fact:
    maintenance_update_packages_apt_before: "{{ maintenance_update_packages_apt_before.stdout_lines | difference(['Listing...']) }}"
    maintenance_update_packages_apt_after: "{{ maintenance_update_packages_apt_after.stdout_lines | difference(['Listing...']) }}"

- name: Set facts to do a diff
  ansible.builtin.set_fact:
    maintenance_update_packages_apt_upgraded: "{{ maintenance_update_packages_apt_before | difference(maintenance_update_packages_apt_after) }}"
    maintenance_update_packages_apt_not_upgraded: "{{ maintenance_update_packages_apt_after | difference(maintenance_update_packages_apt_before) }}"
    maintenance_update_packages_changed: {}

- name: Set fact for maintenance_update_packages_changed
  ansible.builtin.set_fact:
    maintenance_update_packages_changed:
      host: "{{ ansible_hostname }}"
      packages: "{{ maintenance_update_packages_changed | combine({'maintenance_update_packages_apt_upgraded': maintenance_update_packages_apt_upgraded, 'maintenance_update_packages_apt_not_upgraded':
        maintenance_update_packages_apt_not_upgraded}) }}"

- name: Format as yml
  ansible.builtin.set_fact:
    maintenance_update_packages_changed: "{{ maintenance_update_packages_changed | to_yaml(default_flow_style=False) }}"
