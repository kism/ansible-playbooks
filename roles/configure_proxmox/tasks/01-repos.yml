---
- name: Remove enterprise repos
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/pve-enterprise.list
    - /etc/apt/sources.list.d/ceph.list

# - name: Add no-subscription PVE repo # Handled by the script in a sec
#   ansible.builtin.apt_repository:
#     repo: deb http://download.proxmox.com/debian/pve {{ ansible_distribution | lower }} pve-no-subscription
#     filename: pve-no-subscription
#     state: present

- name: Make script directory
  ansible.builtin.file:
    path: /opt/scripts/pve-nag-buster
    state: directory
    mode: "0600"

- name: Check if pve-nag-buster has been used before (hook)
  ansible.builtin.stat:
    path: /etc/apt/apt.conf.d/86pve-nags
  register: pve_nag_buster_hook

- name: Check if pve-nag-buster has been used before (script)
  ansible.builtin.stat:
    path: /usr/share/pve-nag-buster.sh
  register: pve_nag_buster_script

- name: Download the pve-nag-buster script
  ansible.builtin.get_url:
    url: "{{ configure_proxmox_nagbuster_url }}{{ item.filename }}"
    dest: /opt/scripts/pve-nag-buster/{{ item.filename }}
    checksum: sha256:{{ item.sha256sum }}
    mode: "0700"
  register: configure_proxmox_nagbuster_replace_files
  loop: "{{ configure_proxmox_nagbuster_files }}"

- name: Run the pve-nag-buster script
  ansible.builtin.command:
    cmd: /opt/scripts/pve-nag-buster/install.sh --offline
  changed_when: not pve_nag_buster_hook.stat.exists or
    not pve_nag_buster_script.stat.exists or
    configure_proxmox_nagbuster_replace_files.changed
