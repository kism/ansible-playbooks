---
- name: Include tasks, Repository
  ansible.builtin.include_tasks: "01-{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version }}.yml"

- name: Remove filebeat
  ansible.builtin.package:
    name: filebeat
    state: absent

- name: Install packages
  ansible.builtin.package:
    name:
      - elastic-agent
    state: present

- name: Enroll agent
  ansible.builtin.command:
    cmd: elastic-agent enroll --url=https://elk.kg.lan:8220 --enrollment-token={{ secret_elastic_agent_linux_enrolement }}
  register: command_output

- name: Debug
  ansible.builtin.debug:
    var: command_output.stdout_lines

- name: Enable filebeat service
  ansible.builtin.systemd_service:
    name: elastic-agent
    enabled: true
    state: started
