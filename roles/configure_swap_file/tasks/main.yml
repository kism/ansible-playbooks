---
- name: Check if swap file exists
  ansible.builtin.stat:
    path: /swapfile
  register: file_stat

- name: Pre-allocate disk space
  become: true
  ansible.builtin.command:
    cmd: fallocate -l 1G /swapfile
  ignore_errors: true
  register: command_output
  changed_when: not file_stat.stat.exists and command_output.rc == 0

- name: Zero out file
  become: true
  ansible.builtin.command:
    cmd: dd if=/dev/zero of=/swapfile bs=1024 count=1048576
  changed_when: true

- name: Set perms
  ansible.builtin.file:
    path: /swapfile
    state: file
    mode: "0600"

- name: Run mkswap
  become: true
  ansible.builtin.command:
    cmd: mkswap /swapfile
  changed_when: true

- name: Run swapon
  become: true
  ansible.builtin.command:
    cmd: swapon /swapfile

- name: Mount swap proper
  ansible.posix.mount:
    path: stap
    src: /swapfile
    fstype: swap
    opts: sw
    passno: 0
    dump: 0
    state: present
