---
- name: Check if fallocate package is installed # it really should be
  ansible.builtin.package:
    name: util-linux
    state: present

- name: Check if swap file exists
  ansible.builtin.stat:
    path: /swapfile
  register: configure_swap_file_stat

- name: Pre-allocate disk space
  ansible.builtin.command:
    cmd: fallocate -l {{ configure_swap_file_size }} /swapfile
  register: configure_swap_file_fallocate_output
  changed_when: not configure_swap_file_stat.stat.exists and configure_swap_file_fallocate_output.rc == 0
  failed_when: configure_swap_file_fallocate_output.rc != 0 and "Text file busy" not in configure_swap_file_fallocate_output.stderr

- name: Set permissions on swap file
  ansible.builtin.file:
    path: /swapfile
    state: file
    mode: "0600"

- name: Run mkswap
  ansible.builtin.command:
    cmd: mkswap /swapfile
  register: configure_swap_file_mkswap_output
  changed_when: true # Safe assumption
  failed_when: configure_swap_file_mkswap_output.rc != 0 and "swapfile is mounted" not in configure_swap_file_mkswap_output.stderr

- name: Check if swap is active
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      swapon --show | grep -q '/swapfile'
  register: configure_swap_file_swap_status
  changed_when: false # Just gets info
  failed_when: false # Just gets info

- name: Run swapon
  ansible.builtin.command:
    cmd: swapon /swapfile
  register: configure_swap_file_swapon_output
  changed_when: configure_swap_file_swap_status.rc != 0
  failed_when: configure_swap_file_fallocate_output.rc != 0 and "Device or resource busy" not in configure_swap_file_swapon_output.stderr

- name: Mount swap proper
  ansible.posix.mount:
    path: stap
    src: /swapfile
    fstype: swap
    opts: sw
    passno: 0
    dump: 0
    state: present
