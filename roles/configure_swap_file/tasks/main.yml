---
- name: Check if fallocate package is installed # it really should be
  ansible.builtin.package:
    name: util-linux
    state: present

- name: Check if swap file exists
  ansible.builtin.stat:
    path: /swapfile
  register: file_stat

- name: Pre-allocate disk space
  ansible.builtin.command:
    cmd: fallocate -l {{ configure_swap_file_size }} /swapfile
  register: command_output
  changed_when: not file_stat.stat.exists and command_output.rc == 0
  failed_when: command_output.rc != 0 and "Text file busy" not in command_output.stderr

- name: Set perms
  ansible.builtin.file:
    path: /swapfile
    state: file
    mode: "0600"

- name: Run mkswap
  ansible.builtin.command:
    cmd: mkswap /swapfile
  register: mkswap_command_output
  changed_when: true # Safe assumption
  failed_when: mkswap_command_output.rc != 0 and "swapfile is mounted" not in mkswap_command_output.stderr

- name: Check if swap is active
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      swapon --show | grep -q '/swapfile'
  register: swap_status
  changed_when: false # Just gets info
  failed_when: false # Just gets info

- name: Run swapon
  ansible.builtin.command:
    cmd: swapon /swapfile
  register: swapon_command_output
  changed_when: swap_status.rc != 0
  failed_when: command_output.rc != 0 and "Device or resource busy" not in swapon_command_output.stderr

- name: Mount swap proper
  ansible.posix.mount:
    path: stap
    src: /swapfile
    fstype: swap
    opts: sw
    passno: 0
    dump: 0
    state: present
