---
- name: Check if fallocate package is installed # it really should be
  ansible.builtin.package:
    name: util-linux
    state: present

- name: Check if swap file exists
  ansible.builtin.stat:
    path: /swapfile
  register: file_stat

- name: Pre-allocate disk space
  become: true
  ansible.builtin.command:
    cmd: fallocate -l {{ configure_swap_file_size }} /swapfile
  ignore_errors: true
  register: command_output
  changed_when: not file_stat.stat.exists and command_output.rc == 0

- name: Set perms
  ansible.builtin.file:
    path: /swapfile
    state: file
    mode: "0600"

- name: Run mkswap
  become: true
  ansible.builtin.command:
    cmd: mkswap /swapfile
  changed_when: true

- name: Check if swap is active
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      swapon --show | grep -q '/swapfile'
  register: swap_status
  changed_when: false
  failed_when: false

- name: Run swapon
  become: true
  ansible.builtin.command:
    cmd: swapon /swapfile
  register: command_output
  changed_when: swap_status.rc != 0
  failed_when: command_output.rc != 0

- name: Mount swap proper
  ansible.posix.mount:
    path: stap
    src: /swapfile
    fstype: swap
    opts: sw
    passno: 0
    dump: 0
    state: present
