---
- name: Setup telegraf on dnf based hosts
  when: ansible_pkg_mgr == 'dnf'
  block:
    - name: Remove old telegraf key
      ansible.builtin.command:
        cmd: rpm --erase gpg-pubkey-2582e0c5-56099b04
      ignore_errors: true
      tags:
        - skip_ansible_lint

    - name: Copy over influxdb repo
      ansible.builtin.copy:
        src: files/influxdb.repo
        dest: /etc/yum.repos.d/influxdb.repo
        owner: root
        group: root
        mode: "644"

    - name: Import InfluxDB GPG key
      ansible.builtin.rpm_key:
        state: present
        key: https://repos.influxdata.com/influxdb.key

    - name: Install telegraf
      ansible.builtin.dnf:
        name: telegraf
        state: present

- name: Setup telegraf on Ubuntu based hosts
  when: ansible_distribution == 'Ubuntu'
  block:
    - name: Copy over apt key Ubuntu
      ansible.builtin.get_url:
        url: https://repos.influxdata.com/influxdata-archive.key
        dest: /etc/apt/keyrings/influxdata-archive.key
        owner: root
        group: root
        mode: "0644"

    - name: Add Telegraf repository Ubuntu amd64
      ansible.builtin.apt_repository:
        repo: deb [arch=amd64 signed-by=/etc/apt/keyrings/influxdata-archive.key] https://repos.influxdata.com/{{ ansible_distribution | lower }} stable main
        filename: telegraf
        state: present
      when: ansible_architecture == "x86_64"

    - name: Add Telegraf repository Ubuntu arm64
      ansible.builtin.apt_repository:
        repo: deb [arch=arm64 signed-by=/etc/apt/keyrings/influxdata-archive.key] https://repos.influxdata.com/{{ ansible_distribution | lower }} stable main
        filename: telegraf
        state: present
      when: ansible_architecture == "arm64" or ansible_architecture == "aarch64"

- name: Setup telegraf on Debian based hosts
  when: ansible_distribution == 'Debian'
  block:
    - name: Add InfluxDB APT GPG key Debian
      ansible.builtin.apt_key:
        url: https://repos.influxdata.com/influxdata-archive.key
        id: 7df8b07e
        state: present

    - name: Add Telegraf repository Debian
      ansible.builtin.apt_repository:
        repo: deb https://repos.influxdata.com/{{ ansible_distribution | lower }} stable main
        filename: telegraf
        state: present

- name: Install telegraf package apt
  ansible.builtin.apt:
    install_recommends: false
    pkg:
      - telegraf
    state: present
  when: ansible_pkg_mgr == 'apt'

- name: Setup telegraf hosts
  when: ansible_pkg_mgr == 'dnf' or ansible_pkg_mgr == 'apt'
  block:
    - name: Copy common telegraf config
      ansible.builtin.copy:
        src: files/common_influxdb.conf
        dest: /etc/telegraf/telegraf.d/common_influxdb.conf
        owner: telegraf
        group: telegraf
        mode: "600"
      notify:
        - Restart telegraf

    - name: Setup telegraf conf
      ansible.builtin.lineinfile:
        path: /etc/telegraf/telegraf.d/common_influxdb.conf
        regexp: "token = "
        line: token = "{{ secret_influxdb_telegraf_write }}"
        state: present
      notify:
        - Restart telegraf

    - name: Copy host telegraf config
      ansible.builtin.copy:
        src: files/hostconfigs/{{ inventory_hostname }}.conf
        dest: /etc/telegraf/telegraf.d/{{ inventory_hostname }}.conf
        owner: telegraf
        group: telegraf
        mode: "600"
      notify:
        - Restart telegraf

    - name: Start and enable telegraf service
      ansible.builtin.systemd:
        name: telegraf
        state: started
        enabled: true
