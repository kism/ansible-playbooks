---
- name: Block for baremetal hosts
  when: ansible_facts['virtualization_role'] == 'host'
  block:
    - name: "Copy telegraf config: input, disks"
      ansible.builtin.copy:
        src: files/telegraf.d/20-disks.conf
        dest: /etc/telegraf/telegraf.d/20-disks.conf
        mode: "0644"
        owner: root
        group: telegraf
      notify:
        - Restart telegraf

    - name: Install packages
      ansible.builtin.package:
        pkg:
          - nvme-cli
          - smartmontools
        state: present
      when: ansible_distribution != "Archlinux"

    - name: Install packages
      ansible.builtin.package:
        pkg:
          - nvme-cli
          - smartmontools
        state: present
      when: ansible_distribution == "Archlinux"

    - name: Install lm-sensors apt
      ansible.builtin.package:
        pkg:
          - lm-sensors
        state: present
      when: ansible_pkg_mgr == "apt"

    - name: Install lm_sensors dnf
      ansible.builtin.package:
        pkg:
          - lm_sensors
        state: present
      when: ansible_pkg_mgr == "dnf"

    - name: Copy the telegraf sudoers rule baremetal hosts
      ansible.builtin.copy:
        src: files/sudoers_telegraf_disk
        dest: /etc/sudoers.d/telegraf_disk
        mode: "0640"
