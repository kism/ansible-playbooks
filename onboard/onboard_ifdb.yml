---
- name: Basic setup for influxdb
  hosts: all
  become: yes
  collections:
    - community.general
  tasks:
    - name: Copy file with owner and permission, using symbolic representation
      ansible.builtin.copy:
        src: influxdb.repo
        dest: /etc/yum.repos.d/influxdb.repo
        owner: root
        group: root
        mode: u=rw,g=r,o=r

    - name: Install the latest version of
      ansible.builtin.dnf:
        name: influxdb2
        state: latest

    - name: start and enable influxdb service
      service:
        name: influxdb
        enabled: true
        state: started

    - name: Copy wireguard firewalld config
      ansible.builtin.copy:
        src: firewalld/influxdb.xml
        dest: /etc/firewalld/services/influxdb.xml
        owner: root
        group: root
        mode: u+rw,g-wx,o-wx

    - name: Allow influxdb through firewalld
      ansible.posix.firewalld:
        service: influxdb
        zone: public
        permanent: yes
        state: enabled
      notify:
        - Restart firewalld

  handlers:
    - name: Restart firewalld
      ansible.builtin.service:
        name: firewalld
        state: restarted
