---
- name: Basic setup for InfluxDB
  hosts: ifdb
  become: true
  collections:
    - community.general
  tasks:
    - name: Copy file with owner and permission, using symbolic representation
      ansible.builtin.copy:
        src: repos_dnf/influxdb.repo
        dest: /etc/yum.repos.d/influxdb.repo
        owner: root
        group: root
        mode: "644"

    - name: Import InfluxDB GPG key
      ansible.builtin.rpm_key:
        state: present
        key: https://repos.influxdata.com/influxdb.key

    - name: Install InfluxDB
      ansible.builtin.dnf:
        name: influxdb2
        state: present

    - name: Start and enable InfluxDB service
      ansible.builtin.service:
        name: influxdb
        enabled: true
        state: started

    - name: Allow influxdb through firewalld
      ansible.posix.firewalld:
        service: influxdb
        zone: public
        permanent: true
        state: enabled
      notify:
        - Restart firewalld

    - name: Copy repo file to yum.repos.d
      ansible.builtin.copy:
        src: scripts_adhoc/influxping.py
        dest: /opt/scripts/influxping.py
        owner: root
        group: root
        mode: "0755"

    - name: Set ping scan (ping) cron job
      ansible.builtin.cron:
        name: "Ping scan (ping) > InfluxDB"
        minute: "*/5"
        job: "cd /opt/scripts && /opt/scripts/influxping.py ping"

    - name: Set ping scan (scan) cron job
      ansible.builtin.cron:
        name: "Ping scan (ping) > InfluxDB"
        minute: "58"
        job: "cd /opt/scripts && /opt/scripts/influxping.py scan"

  handlers:
    - name: Restart firewalld
      ansible.builtin.service:
        name: firewalld
        state: restarted
