---
# _____________________________________________________________________________
- name: Setup Mounts
  hosts: pvenas
  gather_facts: false
  become: true
  collections:
    - ansible.posix
  tasks:
    - name: Install a list of packages
      ansible.builtin.apt:
        install_recommends: false
        pkg:
          - hdparm
          - smartmontools
        state: present

    - name: Add directories for HDDs
      ansible.builtin.file:
        path: '{{ item }}'
        state: directory
        mode: '0755'
      loop:
        - /srv
        - /srv/Zidane
        - /srv/Vivi
        - /srv/Garnet
        - /srv/Amarant
        - /srv/Freya
        - /srv/Eiko

    - name: Mount up device by label
      ansible.posix.mount:
        path: '/srv/{{ item }}'
        src: 'LABEL={{ item }}'
        fstype: ext4
        state: mounted
      loop:
        - Zidane
        - Vivi
        - Garnet
        - Amarant
        - Freya
        - Eiko

    - name: Unarchive a file that needs to be downloaded (added in 2.0)
      ansible.builtin.unarchive:
        src: https://github.com/Seagate/openSeaChest/releases/download/v22.07/openSeaChest-refs-tags-v22.07-linux-x86_64.tar.xz
        dest: /opt/
        mode: '0755'
        remote_src: true

    - name: Grab openseachest binaries
      ansible.builtin.shell:
        cmd: 'mv /opt/openSeaChest-refs-tags-v22.07-linux-x86_64 /opt/openseachest'
      tags:
        - skip_ansible_lint

    - name: Update CA Certs
      ansible.builtin.shell:
        cmd: 'cp -rs /opt/openseachest/man/* /usr/share/man'
      tags:
        - skip_ansible_lint

    # Copy over scripts
    - name: Copy SMART check script
      ansible.builtin.copy:
        src: scripts_adhoc/pvenas_checksmart.sh
        dest: /root/checksmart.sh
        owner: root
        group: root
        mode: '0700'

    - name: Copy midnight commander script
      ansible.builtin.copy:
        src: scripts_adhoc/pvenas_mc.sh
        dest: /root/mc.sh
        owner: root
        group: root
        mode: '0700'

    - name: Copy perms script
      ansible.builtin.copy:
        src: scripts_adhoc/pvenas_perms.sh
        dest: /root/perms.sh
        owner: root
        group: root
        mode: '0700'

    - name: Copy snapraid conf
      ansible.builtin.copy:
        src: configs/snapraid/snapraid.conf
        dest: /etc/snapraid.conf
        owner: root
        group: root
        mode: '644'

    - name: Copy snapraid conf
      ansible.builtin.copy:
        src: scripts_cron/pvenas_snapraid_helper.sh
        dest: /opt/scripts/snapraid_helper.sh
        owner: root
        group: root
        mode: '700'

    - name: Run snapraid script
      ansible.builtin.cron:
        name: 'Run snapraid script'
        minute: '0'
        hour: '23,09'
        job: '/opt/scripts/snapraid_helper.sh'
