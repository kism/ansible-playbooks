---
# yamllint disable rule:line-length
# _____________________________________________________________________________
- name: Install required sensor packages for telegraf
  hosts: pve:pvenas
  gather_facts: false
  become: true
  tasks:
    - name: Install packages
      ansible.builtin.apt:
        install_recommends: false
        pkg:
          - nvme-cli
          - lm-sensors
        state: present

# _____________________________________________________________________________ TODO FIX FIX FIX
- name: Setup acme and cron job
  hosts: pve:pvenas
  become: true
  tasks:
    - name: Install certbot
      ansible.builtin.apt:
        install_recommends: false
        pkg: certbot
        state: present

    - name: Grab initial acme cert
      become: true
      ansible.builtin.shell:
        cmd: "certbot certonly --non-interactive --agree-tos --standalone --register-unsafely-without-email -v -d {{ ansible_host }} --server https://cert.kg.lan/acme/acme/directory"
      tags:
        - skip_ansible_lint

    - name: Copy the cert post renewell script
      ansible.builtin.copy:
        src: scripts_cron/proxmox_renewcerts.sh
        dest: /opt/scripts/proxmox_renewcerts.sh
        owner: root
        group: root
        mode: "0744"

    - name: Replace hostname in renew
      ansible.builtin.replace:
        path: /opt/scripts/proxmox_renewcerts.sh
        regexp: "HOSTNAME"
        replace: "{{ ansible_host }}"

    - name: Set certbot script cron job
      ansible.builtin.cron:
        name: "Renew SSL Certificate with ACME protocol"
        minute: "0"
        hour: "0,12"
        job: "/usr/bin/certbot renew --quiet --post-hook /opt/scripts/proxmox_renewcerts.sh"

# _____________________________________________________________________________
- name: Setup influxdb
  hosts: pve:pvenas
  become: true
  tasks:
    - name: Copy specific telegraf config
      when: ansible_hostname == 'pvenas'
      ansible.builtin.copy:
        src: configs/telegraf/{{ ansible_hostname }}.conf
        dest: /etc/telegraf/telegraf.d/pvenas.conf
        owner: telegraf
        group: telegraf
        mode: "600"
      notify:
        - Restart telegraf

  handlers:
    - name: Restart telegraf
      ansible.builtin.systemd:
        name: telegraf
        state: restarted
