---
# curl --silent https://raw.githubusercontent.com/kism/ansible-playbooks/master/onboard/init.sh | bash

- name: Basic setup for ent jumpbox
  hosts: all
  become: yes
  collections:
    - community.general
  tasks:
  - name: Install the latest version of firewalld
    ansible.builtin.dnf:
      name:
      - firewalld
      state: latest

  # firewalld
  - name: firewall enabled and running
    service:
      name: firewalld
      enabled: true
      state: started

  - name: Allow ssh
    ansible.posix.firewalld:
      service: ssh
      zone: public
      permanent: yes
      state: enabled

  - name: Remove cockpit firewall rule
    ansible.posix.firewalld:
      service: cockpit
      zone: public
      permanent: yes
      state: disabled

  - name: Restart service cron on centos, in all cases, also issue daemon-reload to pick up config changes
    ansible.builtin.systemd:
      state: restarted
      name: firewalld

# Wireguard
  - name: Install the latest version of wireguard
    ansible.builtin.dnf:
      name:
      - wireguard-tools
      state: latest

  - name: Copy wireguard firewalld config
    ansible.builtin.copy:
      src: firewalld/wireguard.xml
      dest: /etc/firewalld/services/wireguard.xml
      owner: root
      group: root
      mode: u+rw,g-wx,o-wx

  - name: Allow ssh
    ansible.posix.firewalld:
      service: wireguard
      zone: public
      permanent: yes
      state: enabled


# MOTD, bash config
  - name: Copy wireguard firewalld config
    ansible.builtin.copy:
      src: motd/ent.txt
      dest: /etc/motd
      owner: root
      group: root
      mode: u+rw,g-wx,o-wx

  - name: Copy wireguard firewalld config
    ansible.builtin.copy:
      src: dotfiles/ent.bashrc
      dest: /root/.bashrc
      owner: root
      group: root
      mode: u+rw,g-wrx,o-wrx
