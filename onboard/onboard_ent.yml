---
# _____________________________________________________________________________
- name: Basic setup for ent jumpbox
  hosts: ent
  become: true
  collections:
    - community.general
  tasks:
    # Wireguard
    - name: Install wireguard
      ansible.builtin.dnf:
        name:
          - wireguard-tools
        state: present

    - name: Allow wireguard through firewalld
      ansible.posix.firewalld:
        service: wireguard
        zone: public
        permanent: true
        state: enabled
      notify:
        - Restart firewalld

    - name: Set duckdns cron job
      ansible.builtin.cron:
        name: 'Turn off wireguard at 4am'
        minute: '0'
        hour: '4'
        job: '/usr/bin/wg-quick down wg0'

    - name: Copy script to bring up wireguard
      ansible.builtin.copy:
        src: scripts_adhoc/wgup.sh
        dest: /home/kism/wgup.sh
        owner: kism
        group: kism
        mode: '0740'

    # MOTD, bash config
    - name: Copy motd file
      ansible.builtin.copy:
        src: motd/ent.txt
        dest: /etc/motd
        owner: root
        group: root
        mode: '0644'

    - name: Copy ent specific ssh config
      ansible.builtin.copy:
        src: configs/sshd/ent_99-sshnopasswordauth.conf
        dest: /etc/ssh/sshd_config.d/99-sshnopasswordauth.conf
        owner: root
        group: root
        mode: '0600'
      notify:
        - Reload sshd

  handlers:
    - name: Restart firewalld
      ansible.builtin.systemd:
        name: firewalld
        state: restarted

    - name: Reload sshd
      ansible.builtin.systemd:
        name: sshd
        state: reloaded

# _____________________________________________________________________________
- name: Duckdns Setup
  hosts: ent
  become: true
  collections:
    - community.general
  tasks:
    # Duckdns
    - name: Create a /opt/duckdns if it does not exist
      ansible.builtin.file:
        path: /opt/duckdns/
        state: directory
        mode: '0755'

    - name: Enable crond
      ansible.builtin.systemd:
        name: crond
        enabled: true
        state: started

    - name: Copy duck cron job
      ansible.builtin.copy:
        src: scripts_cron/duck.sh
        dest: /opt/duckdns/duck.sh
        owner: root
        group: root
        mode: '0774'

    - name: Set duckdns cron job
      ansible.builtin.cron:
        name: 'Update duckdns'
        minute: '20'
        job: '/opt/duckdns/duck.sh'

    - name: Create ducktoken file
      ansible.builtin.copy:
        dest: '/opt/duckdns/ducktoken'
        mode: '0600'
        owner: root
        group: root
        content: '{{ secret_duckdns }}'

# _____________________________________________________________________________
- name: Setup telegraf
  hosts: ent
  become: true
  tasks:
    - name: Copy ifdb telegraf configs
      ansible.builtin.copy:
        src: configs/telegraf/ent.conf
        dest: /etc/telegraf/telegraf.d/ent.conf
        owner: telegraf
        group: telegraf
        mode: '600'
      notify:
        - Restart telegraf

  handlers:
    - name: Restart telegraf
      ansible.builtin.systemd:
        name: telegraf
        state: restarted

# _____________________________________________________________________________
- name: Setup zsh
  hosts: ent
  become: true
  become_user: kism

  tasks:
    - name: Install zsh
      ansible.builtin.dnf:
        name:
          - zsh
        state: present
      become: true
      become_user: root

    - name: Add my favorite /opt subdirectory
      ansible.builtin.file:
        path: ~/.antigen
        state: directory
        owner: kism
        group: kism
        mode: '0770'

    - name: Download foo.conf
      ansible.builtin.get_url:
        url: https://git.io/antigen
        dest: ~/.antigen/antigen.zsh
        owner: kism
        group: kism
        mode: '0755'

    - name: Copy bash config
      ansible.builtin.copy:
        src: dotfiles/ent.zshrc
        dest: /home/kism/.zshrc
        owner: kism
        group: kism
        mode: '0644'

    - name: Initial certbot config
      become: true
      ansible.builtin.shell:
        cmd: 'zsh -c ". ~/.zshrc; antigen update; antigen reset"'
      register: command_output
      tags:
        - skip_ansible_lint

    - name: Change my shell to zsh
      become: yes
      become_user: root
      ansible.builtin.user:
        name: 'kism'
        shell: /bin/zsh

# _____________________________________________________________________________
- name: Reminders
  hosts: ent
  tasks:
    # REMEMBER
    - name: Reminder
      ansible.builtin.debug:
        msg: Remember to copy the wireguard config to /etc/wireguard/wg0.conf
