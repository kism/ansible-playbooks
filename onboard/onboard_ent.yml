---
- name: Basic setup for ent jumpbox
  hosts: all
  become: true
  collections:
    - community.general
  tasks:
    # Wireguard
    - name: Install the latest version of wireguard
      ansible.builtin.dnf:
        name:
          - wireguard-tools
        state: present

    - name: Allow wireguard through firewalld
      ansible.posix.firewalld:
        service: wireguard
        zone: public
        permanent: true
        state: enabled
      notify:
        - Restart firewalld

    - name: Set duckdns cron job
      ansible.builtin.cron:
        name: "Turn off wireguard at 4am"
        minute: "0"
        hour: "4"
        job: "/usr/bin/wg-quick down wg0"

    - name: Copy script to bring up wireguard
      ansible.builtin.copy:
        src: scripts_adhoc/wgup.sh
        dest: /home/kism/wgup.sh
        owner: kism
        group: kism
        mode: "0740"

    # MOTD, bash config
    - name: Copy motd file
      ansible.builtin.copy:
        src: motd/ent.txt
        dest: /etc/motd
        owner: root
        group: root
        mode: u+rw,g-wx,o-wx

    - name: Copy bash config
      ansible.builtin.copy:
        src: dotfiles/ent.bashrc
        dest: /home/kism/.bashrc
        owner: kism
        group: kism
        mode: u+rw,g-wrx,o-wrx

    # Duckdns
    - name: Create a /opt/duckdns if it does not exist
      ansible.builtin.file:
        path: /opt/duckdns/
        state: directory
        mode: "0755"

    - name: Touch the ducktoken file, set permissions
      ansible.builtin.file:
        path: /opt/duckdns/ducktoken
        state: touch
        mode: "0600"
      changed_when: false # TODO, fix lmao

    - name: Copy duck cron job
      ansible.builtin.copy:
        src: cron/duckdns/duck.sh
        dest: /opt/duckdns/duck.sh
        owner: root
        group: root
        mode: "0744"

    - name: Set duckdns cron job
      ansible.builtin.cron:
        name: "Update duckdns"
        minute: "0"
        job: "/opt/duckdns/duck.sh"

  handlers:
    - name: Restart firewalld
      ansible.builtin.service:
        name: firewalld
        state: restarted

- name: Reminders
  hosts: all
  tasks:
    # REMEMBER
    - name: Reminder
      ansible.builtin.debug:
        msg: Remember to enter the token in /opt/duckdns/ducktoken

    # REMEMBER
    - name: Reminder
      ansible.builtin.debug:
        msg: Remember to copy the wireguard config to /etc/wireguard/wg0.conf
