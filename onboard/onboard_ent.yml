---
# _____________________________________________________________________________
- name: Basic setup for ent jumpbox
  hosts: ent
  become: true
  gather_facts: false
  tasks:
    # MOTD, bash config
    - name: Copy motd file
      ansible.builtin.copy:
        src: configs/motd/ent.txt
        dest: /etc/motd
        owner: root
        group: root
        mode: "0644"

    - name: Copy ent specific ssh config
      ansible.builtin.copy:
        src: configs/sshd/ent_90-sshnopasswordauth.conf
        dest: /etc/ssh/sshd_config.d/99-sshnopasswordauth.conf
        owner: root
        group: root
        mode: "0600"
      notify:
        - Reload sshd

  handlers:
    - name: Restart firewalld
      ansible.builtin.systemd:
        name: firewalld
        state: restarted

    - name: Reload sshd
      ansible.builtin.systemd:
        name: sshd
        state: reloaded

# _____________________________________________________________________________
- name: Duckdns Setup
  hosts: ent
  become: true
  gather_facts: false
  tasks:
    # Duckdns
    - name: Create a /opt/duckdns if it does not exist
      ansible.builtin.file:
        path: /opt/duckdns/
        state: directory
        mode: "0755"

    - name: Enable crond
      ansible.builtin.systemd:
        name: crond
        enabled: true
        state: started

    - name: Copy duck cron job
      ansible.builtin.copy:
        src: scripts_cron/duck.sh
        dest: /opt/duckdns/duck.sh
        owner: root
        group: root
        mode: "0774"

    - name: Set duckdns cron job
      ansible.builtin.cron:
        name: "Update duckdns"
        minute: "20"
        job: "/opt/duckdns/duck.sh"

    - name: Create ducktoken file
      ansible.builtin.copy:
        dest: "/opt/duckdns/ducktoken"
        mode: "0600"
        owner: root
        group: root
        content: "{{ secret_duckdns }}"

# _____________________________________________________________________________
- name: Setup telegraf
  hosts: ent
  become: true
  gather_facts: false
  tasks:
    - name: Copy ifdb telegraf configs
      ansible.builtin.copy:
        src: configs/telegraf/ent.conf
        dest: /etc/telegraf/telegraf.d/ent.conf
        owner: telegraf
        group: telegraf
        mode: "600"
      notify:
        - Restart telegraf

  handlers:
    - name: Restart telegraf
      ansible.builtin.systemd:
        name: telegraf
        state: restarted

# _____________________________________________________________________________
- name: Setup zsh
  hosts: ent
  become: true
  gather_facts: false
  become_user: kism

  tasks:
    - name: Install zsh
      ansible.builtin.dnf:
        name:
          - zsh
        state: present
      become: true
      become_user: root

    - name: Create antigen folder
      ansible.builtin.file:
        path: ~/.antigen
        state: directory
        owner: kism
        group: kism
        mode: "0770"

    - name: Download antigen
      ansible.builtin.get_url:
        url: https://git.io/antigen
        dest: ~/.antigen/antigen.zsh
        owner: kism
        group: kism
        mode: "0755"

    - name: Copy bash config
      ansible.builtin.copy:
        src: dotfiles/ent.zshrc
        dest: /home/kism/.zshrc
        owner: kism
        group: kism
        mode: "0644"

    - name: Setup zsh
      become: true
      ansible.builtin.shell:
        cmd: 'zsh -c ". ~/.zshrc; antigen update; antigen reset"'
      register: command_output
      tags:
        - skip_ansible_lint

    - name: Change my shell to zsh
      become: true
      become_user: root
      ansible.builtin.user:
        name: "kism"
        shell: /bin/zsh


