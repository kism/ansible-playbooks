---
# _____________________________________________________________________________
- name: Setup acme and cron job
  hosts: pve:pvenas
  become: true
  tasks:
    - name: Install certbot
      ansible.builtin.apt:
        install_recommends: false
        pkg: certbot
        state: present

    #certbot certonly --non-interactive --agree-tos --standalone --register-unsafely-without-email -v -d pve.kg.lan --server https://cert.kg.lan/acme/acme/directory
    #certbot certonly --non-interactive --agree-tos --standalone --register-unsafely-without-email -v -d pvenas.kg.lan --server https://cert.kg.lan/acme/acme/directory

    # - name: Grab initial acme cert
    #   become: true
    #   ansible.builtin.shell:
    #     cmd: 'certbot certonly --non-interactive --agree-tos --standalone --register-unsafely-without-email -v -d {{ inventory_hostname }} --server https://cert.kg.lan/acme/acme/directory'
    #   tags:
    #     - skip_ansible_lint

    - name: Copy the cert post renewell script
      ansible.builtin.copy:
        src: scripts_cron/pve_renewcerts.sh
        dest: /opt/scripts/pve_renewcerts.sh
        owner: root
        group: root
        mode: '0744'

    - name: Set certbot script cron job
      ansible.builtin.cron:
        name: 'Renew SSL Certificate with ACME protocol'
        minute: '0'
        hour: '0,12'
        job: '/usr/bin/certbot renew --quiet --post-hook /opt/scripts/pve_renewcerts.sh'
