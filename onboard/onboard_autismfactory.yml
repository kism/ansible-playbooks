---
- name: Basic setup for factorio server
  hosts: autismfactory
  become: true
  vars:
    users:
      - kism
      - skibisky
  collections:
    - community.general
  tasks:
    - name: Assume this is being run on a laptop, disable sleep, hibernate etc
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: false
        masked: true
      loop:
        - sleep.target
        - suspend.target
        - hibernate.target
        - hybrid-sleep.target
      notify:
        - Restart systemd-logind

    - name: Set logind sleep settings, assuming laptop is plugged in
      ansible.builtin.lineinfile:
        path: /etc/systemd/logind.conf
        regexp: "^.?HandleLidSwitchExternalPower"
        line: "HandleLidSwitchExternalPower=ignore"
        state: present
      notify:
        - Restart systemd-logind

    - name: Copy Factorio service
      ansible.builtin.copy:
        src: systemd/system/factorio.service
        dest: /etc/systemd/system/factorio.service
        owner: root
        group: root
        mode: "0644"

    - name: Enable factorio service, don't start it yet
      ansible.builtin.systemd:
        name: factorio
        enabled: true
        masked: false

    - name: Allow factorio through firewalld
      ansible.posix.firewalld:
        service: factorio
        zone: public
        permanent: true
        state: enabled
      notify:
        - Restart firewalld

    - name: Add the user 'factorio' without a shell
      ansible.builtin.user:
        name: factorio
        shell: /bin/false
        append: true

    - name: Add friends linux accounts
      ansible.builtin.user:
        name: "{{ item }}"
        shell: /bin/bash
        append: true
      loop: "{{ users }}"

    - name: Set authorized keys taken from url using lookup
      ansible.posix.authorized_key:
        user: "{{ item }}"
        state: present
        key: "{{ lookup('url', 'https://github.com/' + '{{ item }}' + '.keys', split_lines=False) }}"
      loop: "{{ users }}"

    - name: Add users to factorio group
      ansible.builtin.user:
        name: "{{ item }}"
        groups: factorio
        append: true
      loop: "{{ users }}"

    - name: Copy the factorio sudoers rule
      ansible.builtin.copy:
        src: configs/sudoers/factorio
        dest: /etc/sudoers.d/factorio
        owner: root
        group: root
        mode: "0660"

    - name: Create factorio directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0770"
      loop:
        - /opt/factorio
        - /opt/factorio/saves
        - /opt/factorio/mods

    # - name: Download and unarchive factorio headless
    #   ansible.builtin.unarchive:
    #     src: https://www.factorio.com/get-download/1.1.72/headless/linux64
    #     dest: /opt/
    #     remote_src: true

    - name: Recursively change ownership of a directory
      ansible.builtin.file:
        path: /opt/factorio
        state: directory
        recurse: true
        owner: factorio
        group: factorio

  handlers:
    - name: Restart firewalld
      ansible.builtin.service:
        name: firewalld
        state: restarted

    - name: Restart systemd-logind
      ansible.builtin.service:
        name: systemd-logind
        state: restarted

- name: Reminders
  hosts: all
  tasks:
    - name: Reminder
      ansible.builtin.debug:
        msg: Remember to copy over a save and config, find the paths defined in /etc/systemd/system/factorio.service
