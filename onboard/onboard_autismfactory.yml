---
# _____________________________________________________________________________
- name: Basic setup for factorio server
  hosts: autismfactory
  become: true
  vars:
    users:
      - kism
      - skibisky
  tasks:
    - name: Assume this is being run on a laptop, disable sleep, hibernate etc
      ansible.builtin.systemd:
        name: '{{ item }}'
        enabled: false
        masked: true
      loop:
        - sleep.target
        - suspend.target
        - hibernate.target
        - hybrid-sleep.target
      notify:
        - Restart systemd-logind

    - name: Set logind sleep settings, assuming laptop is plugged in
      ansible.builtin.lineinfile:
        path: /etc/systemd/logind.conf
        regexp: '^.?HandleLidSwitchExternalPower'
        line: 'HandleLidSwitchExternalPower=ignore'
        state: present
      notify:
        - Restart systemd-logind

  handlers:
    - name: Restart systemd-logind
      ansible.builtin.systemd:
        name: systemd-logind
        state: restarted

# _____________________________________________________________________________
- name: Setup telegraf
  hosts: autismfactory
  become: true
  tasks:
    - name: Copy common telegraf configs
      ansible.builtin.copy:
        src: configs/telegraf/autismfactory.conf
        dest: /etc/telegraf/telegraf.d/autismfactory.conf
        owner: telegraf
        group: telegraf
        mode: '600'
      notify:
        - Restart telegraf

  handlers:
    - name: Restart telegraf
      ansible.builtin.systemd:
        name: telegraf
        state: restarted
# # _____________________________________________________________________________
# - name: Duckdns Setup
#   hosts: ent
#   become: true
#   collections:
#     - community.general
#   tasks:
#     # Duckdns
#     - name: Create a /opt/duckdns if it does not exist
#       ansible.builtin.file:
#         path: /opt/duckdns/
#         state: directory
#         mode: '0755'

#     - name: Copy duck cron job
#       ansible.builtin.copy:
#         src: scripts_cron/duck.sh
#         dest: /opt/duckdns/duck.sh
#         owner: root
#         group: root
#         mode: '0774'

#     - name: Set duckdns cron job
#       ansible.builtin.cron:
#         name: 'Update duckdns'
#         minute: '20'
#         job: '/opt/duckdns/duck.sh'

#     - name: Create ducktoken file
#       ansible.builtin.copy:
#         dest: '/opt/duckdns/ducktoken'
#         mode: '0600'
#         owner: root
#         group: root
#         content: '{{ secret_duckdns }}'

#     - name: Setup telegraf conf
#       ansible.builtin.lineinfile:
#         path: /opt/duckdns/duck.sh
#         regexp: 'domain='
#         line: 'domain=autismfactory"'
#         state: present
