---
# _____________________________________________________________________________
- name: Setup nginx
  hosts: podc
  become: true
  gather_facts: false
  tasks:
    - name: Add the user 'podcasto' with a bash shell
      ansible.builtin.user:
        name: podcasto
        uid: 1083
        shell: /bin/false
        append: true

    - name: Create archivepodcast directory
      ansible.builtin.file:
        path: "/opt/archivepodcast"
        state: directory
        owner: podcasto
        group: podcasto
        mode: "0700"

    - name: Attempt to change ownership on /opt/archivepodcast
      ansible.builtin.file:
        path: "/opt/archivepodcast"
        recurse: true
        owner: podcasto
        group: podcasto

# _____________________________________________________________________________
- name: Setup nginx
  hosts: podc
  become: true
  gather_facts: false
  tasks:
    - name: Install nginx and certbot
      ansible.builtin.dnf:
        name:
          - nginx
        state: present

    - name: Copy nginx conf
      ansible.builtin.copy:
        src: "configs/nginx/nginx-podc.conf"
        dest: /etc/nginx/nginx.conf
        mode: "0660"
      notify:
        - Restart nginx

    - name: Set server address
      ansible.builtin.replace:
        path: "/etc/nginx/nginx.conf"
        regexp: "SERVER_NAME"
        replace: "{{ secret_domain }}"

    - name: Create a directory if it does not exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - /etc/nginx/sites-available/
        - /etc/nginx/sites-enabled/

    # I hate these two
    - name: Remove file (delete file)
      ansible.builtin.shell:
        cmd: "rm {{ item }}*"
      ignore_errors: true
      tags:
        - skip_ansible_lint
      loop:
        - /etc/nginx/sites-available/
        - /etc/nginx/sites-enabled/

    - name: Copy nginx site confs
      ansible.builtin.copy:
        src: "configs/nginx/nginx-archivepodcast.conf"
        dest: /etc/nginx/sites-available/
        mode: "0660"
      notify:
        - Restart nginx

    - name: Create symbolic links to make sites available
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/nginx-archivepodcast.conf"
        dest: "/etc/nginx/sites-enabled/nginx-archivepodcast.conf"
        owner: root
        group: root
        state: link
      notify:
        - Restart nginx

    - name: Set server address
      ansible.builtin.replace:
        path: "/etc/nginx/sites-available/nginx-archivepodcast.conf"
        regexp: "secret_domain"
        replace: "{{ secret_domain }}"

    - name: Nginx enabled and running
      ansible.builtin.systemd:
        name: nginx
        enabled: true
      notify: Restart nginx

    - name: Allow http and https
      ansible.posix.firewalld:
        service: "{{ item }}"
        zone: public
        permanent: true
        state: enabled
      loop:
        - http
        - https
      notify:
        - Restart firewalld

  handlers:
    - name: Restart firewalld
      ansible.builtin.systemd:
        name: firewalld
        state: restarted
    - name: Restart nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded

# _____________________________________________________________________________
- name: Setup certbot
  hosts: podc
  become: true
  gather_facts: false
  tasks:
    - name: Install nginx and certbot
      ansible.builtin.dnf:
        name:
          - certbot
          - python3-certbot-nginx
        state: present

    - name: Initial certbot config
      become: true
      ansible.builtin.shell:
        cmd: "certbot --agree-tos --email={{ secret_email }} -v -n --nginx -d {{ secret_domain }}"
      register: command_output
      tags:
        - skip_ansible_lint

# _____________________________________________________________________________
- name: Setup archive-podcast
  hosts: podc
  become: true
  become_user: podcasto
  gather_facts: false
  tasks:
    - name: Clone archivepodcast
      ansible.builtin.git:
        repo: https://github.com/kism/archivepodcast
        dest: /opt/archivepodcast
        single_branch: true
        version: master

    - name: Copy archivepodcast config
      ansible.builtin.copy:
        src: configs/archivepodcast/settings.json
        dest: /opt/archivepodcast/settings.json
        mode: "600"

    - name: Create venv
      become: true
      ansible.builtin.shell:
        cmd: "cd /opt/archivepodcast/ ; python3 -m venv env"
      register: command_output
      tags:
        - skip_ansible_lint

    - name: Install flask into the specified (virtualenv), inheriting globally installed modules
      ansible.builtin.pip:
        requirements: /opt/archivepodcast/requirements.txt
        virtualenv: /opt/archivepodcast/env
        virtualenv_site_packages: true

    - name: Copy systemd service
      become_user: root
      ansible.builtin.copy:
        src: systemd/system/archivepodcast.service
        dest: /etc/systemd/system/archivepodcast.service
        owner: root
        group: root
        mode: "0644"

    - name: Enable systemd service
      ansible.builtin.systemd:
        name: archivepodcast
        enabled: true
        state: started
        masked: false

# _____________________________________________________________________________
- name: Setup telegraf
  hosts: podc
  become: true
  gather_facts: false
  tasks:
    - name: Copy podc telegraf configs
      ansible.builtin.copy:
        src: configs/telegraf/podc.conf
        dest: /etc/telegraf/telegraf.d/podc.conf
        owner: telegraf
        group: telegraf
        mode: "600"
      notify:
        - Restart telegraf

  handlers:
    - name: Restart telegraf
      ansible.builtin.systemd:
        name: telegraf
        state: restarted
