---
- name: Basic setup for Grafana
  hosts: all
  become: true
  collections:
    - community.general
  tasks:
    - name: Copy repo file to yum.repos.d
      ansible.builtin.copy:
        src: repos_dnf/grafana.repo
        dest: /etc/yum.repos.d/grafana.repo
        owner: root
        group: root
        mode: "0644"

    # - name: Import Grafana GPG key
    #   ansible.builtin.rpm_key:
    #     state: present
    #     key: https://rpm.grafana.com/gpg.key

    - name: Install the latest version of Grafana
      ansible.builtin.dnf:
        name: grafana
        state: present

    - name: Start and enable Grafana service
      ansible.builtin.service:
        name: grafana-server
        enabled: true
        state: started

    - name: Allow Grafana through firewalld
      ansible.posix.firewalld:
        service: grafana
        zone: public
        permanent: true
        state: enabled
      notify:
        - Restart firewalld

  handlers:
    - name: Restart firewalld
      ansible.builtin.service:
        name: firewalld
        state: restarted
