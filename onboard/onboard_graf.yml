---
# yamllint disable rule:line-length
# _____________________________________________________________________________
- name: Basic setup for Grafana
  hosts: graf
  become: true
  gather_facts: false
  tasks:
    - name: Copy repo file to yum.repos.d
      ansible.builtin.copy:
        src: repos_dnf/grafana.repo
        dest: /etc/yum.repos.d/grafana.repo
        owner: root
        group: root
        mode: "0644"

    # - name: Import Grafana GPG key
    #   ansible.builtin.rpm_key:
    #     state: present
    #     key: https://rpm.grafana.com/gpg.key

    - name: Install Grafana
      ansible.builtin.dnf:
        name: grafana
        state: present

    - name: Start and enable Grafana service
      ansible.builtin.systemd:
        name: grafana-server
        enabled: true
        state: started

    - name: Allow Grafana and nginx through firewalld
      ansible.posix.firewalld:
        service: "{{ item }}"
        zone: public
        permanent: true
        state: enabled
      loop:
        - https
        - http
        - grafana
      notify:
        - Restart firewalld

  handlers:
    - name: Restart firewalld
      ansible.builtin.systemd:
        name: firewalld
        state: restarted

# _____________________________________________________________________________
- name: Setup for Nginx for Grafana
  hosts: graf
  become: true
  gather_facts: false
  tasks:
    - name: Install nginx and certbot
      ansible.builtin.dnf:
        name:
          - nginx
          - certbot
          - python3-certbot-nginx
        state: present

    - name: Remove nginx grafana config for a sec
      ansible.builtin.file:
        path: /etc/nginx/conf.d/nginx-grafana.conf
        state: absent

    - name: Copy renewcerts cron job
      ansible.builtin.copy:
        src: scripts_cron/renewcerts.sh
        dest: /opt/scripts/renewcerts.sh
        owner: root
        group: root
        mode: "0744"

    - name: Enable crond
      ansible.builtin.systemd:
        name: crond
        enabled: true
        state: started

    - name: Set certbot script cron job
      ansible.builtin.cron:
        name: "Renew SSL Certificate with ACME protocol"
        minute: "0"
        hour: "0,12"
        job: "/bin/bash /opt/scripts/renewcerts.sh"

    - name: Grab a new cert
      ansible.builtin.shell: "REQUESTS_CA_BUNDLE=/etc/pki/tls/certs/kglan_root.cer certbot certonly --agree-tos --email=kg@localhost -v -n --nginx -d graf.kg.lan --server https://cert.kg.lan/acme/acme/directory"
      tags:
        - skip_ansible_lint

    - name: Copy nginx-grafana.conf
      ansible.builtin.copy:
        src: configs/nginx/nginx-grafana.conf
        dest: /etc/nginx/conf.d/nginx-grafana.conf
        owner: root
        group: root
        mode: "0644"
      notify:
        - Restart nginx

    - name: Kill nginx (I hate this, I think its something to do with certbot)
      ansible.builtin.shell: "killall nginx"
      notify:
        - Restart nginx
      tags:
        - skip_ansible_lint

  handlers:
    - name: Restart nginx
      ansible.builtin.systemd:
        name: nginx
        state: restarted
