---
#- name: Create Proxmox LXC Container
#  hosts: proxmox
#  become: yes
#  tasks:
#  - name: Create a new container
#    community.general.proxmox:
#      vmid: 100
#      node: pve
#      api_user: root@pam
#      api_token_id : ansible
#      api_token_secret : 475b8a8f-9b98-476a-8bde-61e88d72818e
#      api_host: pve.kg.lan
#      password: 123456
#      hostname: podc
#      ostemplate: local:vztmpl/centos-8-default_20191016_amd64.tar.xz'

#  - name: Start container
#    community.general.proxmox:
#      vmid: 100
#      api_user: root@pam
#      api_password: 1q2w3e
#      api_host: node1
#      state: started

- name: Podcast Archiver
  hosts: podc
  become: yes
  tasks:
#    - name: Update DNF Cache
#      dnf:
#        update_cache: yes
#        state: latest

    - name: Upgrade packages
      dnf:
        update_only: yes
        state: latest

    - name: Enable epel
      dnf:
        name: epel-release
        state: latest

    - name: Install Packages
      dnf:
        name:
          - nginx
          - python3
          - python3-pip
          - htop
          - tmux
          - vim
          - firewalld
        state: latest

    - name: firewall enabled and running
      service:
        name: firewalld
        enabled: true
        state: started

    - name: Name Let Nginx 80 through firewalld
      firewalld:
        zone: public
        service:  http
        permanent: true
        immediate: true
        state: enabled

    - name: Name Let Nginx 443 through firewalld
      firewalld:
        zone: public
        service:  https
        permanent: true
        immediate: true
        state: enabled

    - name: Nginx enabled and running
      service:
        name: nginx
        enabled: true
        state: started

    - name: copy podcast archive script
      copy:
        src: ~/src/archivepodcast/archivepodcast.py
        dest: /root/

    - name: copy podcast archive settings.json
      copy:
        src: settings.json
        dest: /root/

    - name: copy webroot
      copy:
        src: webroot/
        dest: /usr/share/nginx/html

    - name: copy nginx.conf
      copy:
        src: nginx.conf
        dest: /etc/nginx/nginx.conf

    - name: Restart service httpd, in all cases
      service:
        name: nginx
        state: restarted

    - name: Install latest version of python package 'requests'
      pip:
        name: requests

    - name: Run a script with arguments (using 'cmd' parameter)
      script:
        chdir: /root
        cmd: ~/src/archivepodcast/archivepodcast.py
        executable: python3
